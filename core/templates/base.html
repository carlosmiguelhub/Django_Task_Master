{% load static %}
<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="{% static 'css/styles.css' %}" rel="stylesheet">
  <title>{% block title %}Task Master{% endblock %}</title>
</head>

<!-- REMOVE flex classes from body -->
<body class="min-h-screen bg-slate-50 text-slate-900 antialiased">

  <!-- Make layout flex here instead -->
  <div class="min-h-screen flex flex-col">

    {% block navbar %}
    <!-- Global Navbar -->
    <header class="sticky top-0 z-50 border-b border-slate-200 bg-white/80 backdrop-blur">
      <div class="mx-auto max-w-screen-2xl px-4 sm:px-6">
        <div class="flex h-14 items-center justify-between">

          <!-- Brand -->
          <a href="/app/dashboard/" class="flex items-center gap-3">
            <span class="text-sm font-semibold tracking-tight text-slate-900">
              Task Master
            </span>
          </a>

          <!-- Right side -->
          <div class="flex items-center gap-3">

            {% if request.user.is_authenticated %}
            <!-- Profile Dropdown -->
            <div class="relative" id="profileMenu">
              <button type="button" id="profileBtn"
                      class="flex h-9 w-9 items-center justify-center rounded-full bg-slate-900 text-sm font-semibold text-white hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-slate-200"
                      aria-haspopup="true" aria-expanded="false">
                {{ request.user.username|slice:":1"|upper }}
              </button>

              <div id="profileDropdown"
                   class="absolute right-0 mt-2 w-56 hidden overflow-hidden rounded-xl border border-slate-200 bg-white shadow-lg">
                <div class="px-4 py-3 border-b border-slate-100">
                  <div class="text-sm font-semibold text-slate-900 truncate">
                    {% if request.user.get_full_name %}
                      {{ request.user.get_full_name }}
                    {% else %}
                      {{ request.user.username }}
                    {% endif %}
                  </div>
                  <div class="text-xs text-slate-500 truncate">
                    {{ request.user.email }}
                  </div>
                </div>

                <a href="#"
                   class="flex items-center gap-2 px-4 py-2.5 text-sm font-medium text-slate-700 hover:bg-slate-50">
                  <!-- user icon -->
                  <svg class="h-4 w-4 text-slate-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21a8 8 0 0 0-16 0"/>
                    <circle cx="12" cy="7" r="4"/>
                  </svg>
                  View Profile
                </a>

                <form method="post" action="{% url 'accounts:logout' %}">
                  {% csrf_token %}
                  <button type="submit"
                          class="flex w-full items-center gap-2 px-4 py-2.5 text-sm font-semibold text-red-600 hover:bg-red-50">
                    <!-- logout icon -->
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                      <path d="M16 17l5-5-5-5"/>
                      <path d="M21 12H9"/>
                    </svg>
                    Logout
                  </button>
                </form>
              </div>
            </div>

            {% else %}
            <!-- When logged out -->
            <a href="{% url 'accounts:login' %}"
               class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-700 shadow-sm hover:bg-slate-50">
              Login
            </a>
            <a href="{% url 'accounts:register' %}"
               class="rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:opacity-95">
              Get Started
            </a>
            {% endif %}

          </div>
        </div>
      </div>
    </header>
    {% endblock navbar %}

    <!-- Page content -->
    <main class="w-full flex-1">
      {% block body %}{% endblock %}
    </main>

  </div>

  <!-- Dropdown script (safe + no errors on pages without profile) -->
  <script>
    (function () {
      const btn = document.getElementById("profileBtn");
      const dd = document.getElementById("profileDropdown");
      const wrap = document.getElementById("profileMenu");

      if (!btn || !dd || !wrap) return;

      function close() {
        dd.classList.add("hidden");
        btn.setAttribute("aria-expanded", "false");
      }

      function toggle() {
        dd.classList.toggle("hidden");
        btn.setAttribute("aria-expanded", dd.classList.contains("hidden") ? "false" : "true");
      }

      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        toggle();
      });

      document.addEventListener("click", (e) => {
        if (!wrap.contains(e.target)) close();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") close();
      });
    })();
  </script>

</body>
</html>
